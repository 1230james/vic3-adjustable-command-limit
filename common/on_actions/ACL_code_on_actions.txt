### Calculate & apply overstacking debuffs
#   Root = attacker or defender country
#   scope:battle = battle
#   scope:attacker = attacking commander
#   scope:defender = defending commander
#   scope:state = location state
on_battle_started = {
    effect = {
        scope:attacker = {
            
            ### TODO: Figure out how to use variables here to avoid double computation
            
            #set_variable = {
            #    name  = unit_cap
            #    value = ACL_overstacking_penalty_mult
            #}
            if = {
                limit  = {
                    has_trait = ACL_lim_over_25_trait
                    ACL_overstacking_penalty_mult > 0 #scope:unit_cap > 0
                }
                add_modifier = {
                    name       = ACL_overstacking_penalty_modifier
                    multiplier = ACL_overstacking_penalty_mult #scope:unit_cap
                    months     = -1
                }
            }
            #remove_variable = unit_cap
        }
        scope:defender = {
            # TODO
        }
    }
}

### Remove overstacking debuffs on battle end
#   Root = attacker or defender country
#   scope:battle = battle
#   scope:attacker = attacking commander
#   scope:defender = defending commander
#   scope:state = location state
on_battle_ended = {
    scope:attacker = {
        if = {
            limit = {
                has_modifier = ACL_overstacking_penalty_modifier
            }
            remove_modifier = ACL_overstacking_penalty_modifier
        }
    }
    scope:defender = {
        if = {
            limit = {
                has_modifier = ACL_overstacking_penalty_modifier
            }
            remove_modifier = ACL_overstacking_penalty_modifier
        }
    }
}